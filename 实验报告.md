# FindU 失物招领系统实验报告

## 一、实验名称

基于 Jetpack Compose + Supabase 的移动端失物招领系统（FindU）

---

## 二、实验目的

- 掌握 Android 端现代 UI（Jetpack Compose + Material3）开发流程
- 学习使用 Supabase（Auth + Postgrest）快速搭建云端后端
- 实现用户注册/登录与云端数据持久化
- 通过 Repository + ViewModel + StateFlow 构建可维护的应用架构
- 实现跨用户物品匹配与通知系统
- 集成高德地图实现位置服务与导航功能

---

## 三、实验环境

### 1. 软件环境

- 操作系统：Windows
- IDE：Android Studio
- JDK：17
- Gradle Plugin：8.13.0
- Kotlin：1.9.24
- Compose BOM：2023.08.00

### 2. 主要依赖

- Jetpack Compose（Material3）
- Lifecycle ViewModel + StateFlow
- Supabase Kotlin SDK：2.5.0
  - Postgrest
  - GoTrue（Auth）
  - Storage
- Ktor Android Client：2.3.12

---

## 四、需求分析

### 1. 功能需求

- **用户模块**
  - 注册、登录、退出
  - 个人中心展示用户名和物品列表
  - 自动创建用户资料（从 Auth 邮箱提取用户名）
- **物品模块**
  - 拾得物品发布（支持拍照/相册选择图片）
  - 遗失物品发布
  - 8 种物品类别：校园卡、钥匙、耳机、钱包、衣物、书包、电子产品、其他
  - 列表查看（首页动态、全部动态、个人中心）
- **匹配与通知模块**
  - 跨用户匹配：拾得物品自动匹配其他用户的遗失物品
  - 相似度计算：基于类别、颜色、特征描述等
  - 双向状态同步：匹配成功后更新双方物品状态
  - 通知推送：匹配成功自动向失主发送通知
  - 未读通知徽章显示
- **地图导航模块**
  - 显示物品拾得位置
  - 支持高德地图 App 内导航或跳转外部地图

### 2. 非功能需求

- 数据安全：使用 Supabase RLS（行级安全）控制用户数据权限
- 可维护性：采用 Repository/ViewModel 分层架构
- 用户体验：统一的 UI 风格，拾得端橙色主题、遗失端蓝色主题

---

## 五、总体设计

### 1. 架构设计

采用典型的三层结构：

- UI（Compose Screens）
- ViewModel（StateFlow 管理 UI 状态）
- Repository（Supabase 数据访问封装）

关键模块：

- `SupabaseClient`：初始化 Supabase Client，并安装 Postgrest/Storage/Auth
- `SupabaseRepository`：封装所有云端表的 CRUD
- `AuthViewModel`：调用 Supabase Auth 完成注册/登录/退出
- `HomeViewModel / ProfileViewModel`：页面数据加载与刷新

### 2. 数据库设计

Supabase 中存在两类用户数据：

- `auth.users`：Supabase 内置认证表（自动维护）
- `public.users`：应用自定义用户资料表（需手动创建）

本实验通过 `supabase_users_table.sql` 创建 `public.users`，并通过外键 `id -> auth.users(id)` 关联。

字段：
- `id`（UUID，主键，外键引用 auth.users）
- `username`（用户名）
- `phone`（手机号）
- `email`（邮箱）
- `created_at / updated_at`

同时开启 RLS：
- SELECT：允许查看（可按需求调整）
- INSERT：仅允许插入自己的资料（`auth.uid() = id`）
- UPDATE：仅允许更新自己的资料（`auth.uid() = id`）

---

## 六、关键实现

### 1. Supabase 初始化

- 文件：`SupabaseClient.kt`
- 安装模块：Postgrest / Storage / Auth
- 配置项目 URL 和 API Key

### 2. 用户注册登录与资料管理

- 文件：`AuthViewModel.kt`、`ProfileViewModel.kt`
- 注册流程：
  1. `auth.signUpWith(Email)` 创建 Auth 用户
  2. 获取用户 ID 后调用 `createUserProfile` 写入用户资料
- 自动资料创建：
  - 若用户资料不存在，从 Auth Session 获取邮箱
  - 自动提取邮箱 `@` 前部分作为用户名并创建资料

### 3. 图片上传处理

- 文件：`ImageUtils.kt`、`UploadImageScreen.kt`
- 相机拍照：动态请求 CAMERA 权限，使用 FileProvider 创建临时文件
- 相册选择：将 content URI 复制到应用私有目录，获取真实文件路径
- 图片压缩：自动压缩至 150KB 以下

### 4. 跨用户匹配系统

- 文件：`FoundItemFormViewModel.kt`
- 匹配流程：
  1. 提交拾得物品后，查询所有"寻找中"状态的遗失物品
  2. 使用 `MatchingService.calculateSimilarity` 计算相似度
  3. 相似度 > 0.7 时判定为匹配成功
- 双向状态更新：
  - 更新遗失物品状态为"已匹配"
  - 更新拾得物品状态为"已匹配"
- 使用 `NonCancellable` 上下文确保关键操作不被取消

### 5. 通知系统

- 文件：`SupabaseRepository.kt`、`MessageViewModel.kt`
- 通知插入：使用 `buildJsonObject` 构建 JSON 数据避免序列化问题
- 未读统计：处理 `is_read` 为 null 或 false 的情况
- 通知显示：支持标记已读、显示未读徽章

### 6. 地图导航集成

- 文件：`MatchedResultScreen.kt`
- 高德地图 SDK 集成
- 支持 App 内导航和跳转外部地图应用

---

## 七、测试与结果

### 1. 功能测试用例

| 测试项 | 操作 | 预期结果 | 实际结果 |
|--------|------|----------|----------|
| 用户注册 | 输入用户名、密码注册 | Auth 创建用户，users 表写入资料 | ✅ 通过 |
| 用户登录 | 使用已注册账号登录 | 登录成功，跳转首页 | ✅ 通过 |
| 拾得物品发布 | 选择类别、填写信息、上传图片 | found_items 新增记录 | ✅ 通过 |
| 遗失物品发布 | 选择类别、填写信息 | lost_items 新增记录 | ✅ 通过 |
| 相机拍照 | 点击拍照按钮 | 请求权限后打开相机 | ✅ 通过 |
| 相册选择 | 点击相册按钮 | 选择图片后正确显示 | ✅ 通过 |
| 跨用户匹配 | 用户A发布遗失，用户B发布匹配的拾得 | 双方状态更新为"已匹配" | ✅ 通过 |
| 通知推送 | 匹配成功后 | 失主收到通知，显示未读徽章 | ✅ 通过 |
| 图片显示 | 查看匹配详情 | 正确显示物品图片 | ✅ 通过 |
| 个人中心 | 进入个人页面 | 显示用户名和物品列表 | ✅ 通过 |

### 2. 测试结果

- ✅ 数据成功持久化到 Supabase 云端（found_items / lost_items / notifications / users）
- ✅ 跨用户匹配功能正常工作
- ✅ 通知系统正常推送和显示
- ✅ 图片上传和显示功能正常
- ✅ 用户资料自动创建和显示正常
- ✅ UI 界面统一，拾得端橙色/遗失端蓝色区分清晰

---

## 八、问题与改进

### 1. 问题

- Supabase Auth 用户与自定义资料表需要手动桥接，否则 `public.users` 会为空
- 若启用了邮箱验证，虚拟邮箱无法确认导致登录失败
- 未使用 Realtime 时，无法做到真正“推送式实时更新”

### 2. 改进方向

- 引入 Supabase Realtime：对 `found_items/lost_items/notifications` 订阅变化，实现真正实时推送
- 将 Supabase key 与第三方 key 做安全管理（服务端下发/环境变量等）
- 将图片上传改为 Supabase Storage（当前已有依赖，可扩展）
- 增加错误上报与更细粒度的异常提示

---

## 九、总结

本实验成功完成了一个功能完整的失物招领系统，主要成果包括：

### 技术成果

- 采用 **Jetpack Compose + Material3** 构建现代化 Android UI
- 使用 **Supabase** 作为云端后端，实现多用户数据同步
- 通过 **Repository + ViewModel + StateFlow** 架构保证代码可维护性
- 集成**高德地图 SDK** 实现位置服务与导航功能

### 功能成果

- ✅ 完整的用户认证系统（注册/登录/退出）
- ✅ 拾得物品发布（支持拍照/相册图片上传）
- ✅ 遗失物品发布
- ✅ **跨用户智能匹配**（基于物品特征相似度）
- ✅ **实时通知系统**（匹配成功自动通知失主）
- ✅ **双向状态同步**（匹配后更新双方物品状态）
- ✅ 个人中心（显示用户名、物品列表及状态）
- ✅ 地图导航（查看物品位置并导航）

### 学习收获

- 掌握了 Compose 声明式 UI 开发模式
- 学习了 Supabase BaaS 平台的使用方法
- 理解了 Android 权限管理和文件处理机制
- 实践了协程和 StateFlow 的异步编程模式

本项目代码结构清晰、功能完整，可作为失物招领类应用的参考实现。
